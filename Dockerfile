FROM node:22-alpine AS build
WORKDIR /app

ARG PREPROD_UTXORPC_API_KEY
ARG PREPROD_UTXORPC_URL
ARG PREPROD_BLOCKFROST_URL
ARG PREPROD_BLOCKFROST_API_KEY
ARG PREPROD_DB_SYNC_CONNECTION_STRING
ARG PREVIEW_UTXORPC_API_KEY
ARG PREVIEW_UTXORPC_URL
ARG PREVIEW_BLOCKFROST_URL
ARG PREVIEW_BLOCKFROST_API_KEY
ARG PREVIEW_DB_SYNC_CONNECTION_STRING
ARG MAINNET_UTXORPC_API_KEY
ARG MAINNET_UTXORPC_URL
ARG MAINNET_BLOCKFROST_URL
ARG MAINNET_BLOCKFROST_API_KEY
ARG MAINNET_DB_SYNC_CONNECTION_STRING
ARG AF_VECTOR_TESTNET_UTXORPC_API_KEY
ARG AF_VECTOR_TESTNET_UTXORPC_URL
ARG AF_VECTOR_TESTNET_BLOCKFROST_URL
ARG AF_VECTOR_TESTNET_BLOCKFROST_API_KEY
ARG AF_VECTOR_TESTNET_DB_SYNC_CONNECTION_STRING
ARG AF_VECTOR_MAINNET_UTXORPC_API_KEY
ARG AF_VECTOR_MAINNET_UTXORPC_URL
ARG AF_VECTOR_MAINNET_BLOCKFROST_URL
ARG AF_VECTOR_MAINNET_BLOCKFROST_API_KEY
ARG AF_VECTOR_MAINNET_DB_SYNC_CONNECTION_STRING
ARG AF_PRIME_TESTNET_UTXORPC_API_KEY
ARG AF_PRIME_TESTNET_UTXORPC_URL
ARG AF_PRIME_TESTNET_BLOCKFROST_URL
ARG AF_PRIME_TESTNET_BLOCKFROST_API_KEY
ARG AF_PRIME_TESTNET_DB_SYNC_CONNECTION_STRING
ARG AF_PRIME_MAINNET_UTXORPC_API_KEY
ARG AF_PRIME_MAINNET_UTXORPC_URL
ARG AF_PRIME_MAINNET_BLOCKFROST_URL
ARG AF_PRIME_MAINNET_BLOCKFROST_API_KEY
ARG AF_PRIME_MAINNET_DB_SYNC_CONNECTION_STRING



COPY package.json ./
COPY pnpm-lock.yaml ./
COPY svelte.config.js ./
COPY vite.config.ts ./
COPY tsconfig.json ./

RUN npm i -g pnpm
RUN pnpm install

COPY . .

ENV PREPROD_UTXORPC_API_KEY=$PREPROD_UTXORPC_API_KEY
ENV PREPROD_UTXORPC_URL=$PREPROD_UTXORPC_URL
ENV PREPROD_BLOCKFROST_URL=$PREPROD_BLOCKFROST_URL
ENV PREPROD_BLOCKFROST_API_KEY=$PREPROD_BLOCKFROST_API_KEY
ENV PREPROD_DB_SYNC_CONNECTION_STRING=$PREPROD_DB_SYNC_CONNECTION_STRING
ENV PREVIEW_UTXORPC_API_KEY=$PREVIEW_UTXORPC_API_KEY
ENV PREVIEW_UTXORPC_URL=$PREVIEW_UTXORPC_URL
ENV PREVIEW_BLOCKFROST_URL=$PREVIEW_BLOCKFROST_URL
ENV PREVIEW_BLOCKFROST_API_KEY=$PREVIEW_BLOCKFROST_API_KEY
ENV PREVIEW_DB_SYNC_CONNECTION_STRING=$PREVIEW_DB_SYNC_CONNECTION_STRING
ENV MAINNET_UTXORPC_API_KEY=$MAINNET_UTXORPC_API_KEY
ENV MAINNET_UTXORPC_URL=$MAINNET_UTXORPC_URL
ENV MAINNET_BLOCKFROST_URL=$MAINNET_BLOCKFROST_URL
ENV MAINNET_BLOCKFROST_API_KEY=$MAINNET_BLOCKFROST_API_KEY
ENV MAINNET_DB_SYNC_CONNECTION_STRING=$MAINNET_DB_SYNC_CONNECTION_STRING
ENV AF_VECTOR_TESTNET_UTXORPC_API_KEY=$AF_VECTOR_TESTNET_UTXORPC_API_KEY
ENV AF_VECTOR_TESTNET_UTXORPC_URL=$AF_VECTOR_TESTNET_UTXORPC_URL
ENV AF_VECTOR_TESTNET_BLOCKFROST_URL=$AF_VECTOR_TESTNET_BLOCKFROST_URL
ENV AF_VECTOR_TESTNET_BLOCKFROST_API_KEY=$AF_VECTOR_TESTNET_BLOCKFROST_API_KEY
ENV AF_VECTOR_TESTNET_DB_SYNC_CONNECTION_STRING=$AF_VECTOR_TESTNET_DB_SYNC_CONNECTION_STRING
ENV AF_VECTOR_MAINNET_UTXORPC_API_KEY=$AF_VECTOR_MAINNET_UTXORPC_API_KEY
ENV AF_VECTOR_MAINNET_UTXORPC_URL=$AF_VECTOR_MAINNET_UTXORPC_URL
ENV AF_VECTOR_MAINNET_BLOCKFROST_URL=$AF_VECTOR_MAINNET_BLOCKFROST_URL
ENV AF_VECTOR_MAINNET_BLOCKFROST_API_KEY=$AF_VECTOR_MAINNET_BLOCKFROST_API_KEY
ENV AF_VECTOR_MAINNET_DB_SYNC_CONNECTION_STRING=$AF_VECTOR_MAINNET_DB_SYNC_CONNECTION_STRING
ENV AF_PRIME_TESTNET_UTXORPC_API_KEY=$AF_PRIME_TESTNET_UTXORPC_API_KEY
ENV AF_PRIME_TESTNET_UTXORPC_URL=$AF_PRIME_TESTNET_UTXORPC_URL
ENV AF_PRIME_TESTNET_BLOCKFROST_URL=$AF_PRIME_TESTNET_BLOCKFROST_URL
ENV AF_PRIME_TESTNET_BLOCKFROST_API_KEY=$AF_PRIME_TESTNET_BLOCKFROST_API_KEY
ENV AF_PRIME_TESTNET_DB_SYNC_CONNECTION_STRING=$AF_PRIME_TESTNET_DB_SYNC_CONNECTION_STRING
ENV AF_PRIME_MAINNET_UTXORPC_API_KEY=$AF_PRIME_MAINNET_UTXORPC_API_KEY
ENV AF_PRIME_MAINNET_UTXORPC_URL=$AF_PRIME_MAINNET_UTXORPC_URL
ENV AF_PRIME_MAINNET_BLOCKFROST_URL=$AF_PRIME_MAINNET_BLOCKFROST_URL
ENV AF_PRIME_MAINNET_BLOCKFROST_API_KEY=$AF_PRIME_MAINNET_BLOCKFROST_API_KEY
ENV AF_PRIME_MAINNET_DB_SYNC_CONNECTION_STRING=$AF_PRIME_MAINNET_DB_SYNC_CONNECTION_STRING

RUN pnpm run build

RUN env > .env

FROM node:22-alpine AS production


WORKDIR /app

COPY package.json pnpm-lock.yaml ./
RUN npm i -g pnpm
RUN pnpm install --prod --frozen-lockfile

COPY --from=build /app/build ./build
COPY --from=build /app/.env ./.env

EXPOSE 3000

RUN env > .env

CMD ["node", "--env-file=.env", "build"]
